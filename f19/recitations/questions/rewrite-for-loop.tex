\checkpoint*{\TAGS{correctness, safety, syntax, loop-invariant}}

A water main break in GHC has unexpectedly removed \lstinline'for'
loops and all contracts except for \lstinline'//@assert' from the C0
compiler! This means the function below won't compile anymore :-(
Rewrite the \lstinline'for' loop and the contracts so that it
compiles, and all operations (contract checks, loop guard checks,
assignments, etc) happen in the same order as when this code is
normaly compiled with the \lstinline'-d' flag.

\smallskip

\smalllistings
\begin{lstlisting}[numbers=left]
int search(int x, int[] A, int n)
//@requires n == \length(A);
//@ensures -1 <= \result && \result < n;
{
  for (int i = 0; i < n; i++)
  //@loop_invariant 0 <= i;
  {
    if (A[i] == x) return i;
  }
  return -1;
}
\end{lstlisting}

\begin{solution}
\begin{lstlisting}[numbers=left]
int search(int x, int[] A, int n) {
  //@assert n == \length(A); // This one can't be assert()

  int i = 0; // Technically, this should be in a new scope
  //@assert 0 <= i;
  while (i < n) {
    if (A[i] == x) {
      //@assert -1 <= i && i < n;
      return i;
    }
    i++;
    //@assert 0 <= i;
  }

  //@assert -1 <= -1 && -1 <= n;
  return -1;
}
\end{lstlisting}
\end{solution}
