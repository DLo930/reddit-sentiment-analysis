TITLE: Can you find the bug?

CONTENT (paste into plain-text editor on Piazza):
=================================================

Here's a challenge: the following is a lightly-edited excerpt of the code for a popular open-source program. There's a subtle bug in this code that is estimated to have cost the global community hundreds of millions of dollars in damages. Can you identify the bug and explain why it caused so much trouble?

<pre>int tls1_process_heartbeat(SSL *s) {
    char *p = s-&gt;data; /* this comes from the user over the network */
    char *pl;
    char hbtype;
    int payload; /* payload length */
    int padding = 16; /* Use minimum padding */

    /* Read type and payload length first */
    hbtype = *p;
    p++;
    payload = *(int*)p;
    p += 4;
    pl = p;

    if (hbtype == TLS1_HB_REQUEST)
        {
        char *buffer;
        char *bp;
        int r;

        /* Allocate memory for the response, size is 1 bytes
         * message type, plus 4 bytes payload length, plus
         * payload, plus padding
         */
        buffer = xmalloc(1 + 4 + payload + padding);
        bp = buffer;

        /* Enter response type, length and copy payload */
        *bp = TLS1_HB_RESPONSE;
        bp++;
        int *temp = (int*)bp;
        *temp = payload;
        bp += 4;
        memcpy(bp, pl, payload);
        bp += payload;
        /* Random padding */
        RAND_pseudo_bytes(bp, padding);

        ssl3_write_bytes(s, TLS1_RT_HEARTBEAT, buffer, 5 + payload + padding);

        free(buffer);
    }
    // ...
}</pre>
<a href="https://git.openssl.org/gitweb/?p=openssl.git;a=blob;f=ssl/t1_lib.c;h=a2e2475d136f33fa26958fd192b8ace158c4899d#l3963" target="_blank">[source]</a>
