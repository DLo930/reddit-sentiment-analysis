%%% listings style for c0
\usepackage[table,usenames,dvipsnames]{xcolor}
\usepackage[T1]{fontenc}
\usepackage[scaled]{beramono}
\usepackage{listings}

\newcommand{\basicColor}{black}
\newcommand{\numberColor}{black}
\newcommand{\commentColor}{MidnightBlue}
\newcommand{\stringColor}{OliveGreen}
\newcommand{\contractColor}{Mahogany}

\newcommand{\codefont}{fvm}  % Font to use for code
\newcommand{\basicstyle}{\normalsize\fontfamily{\codefont}\selectfont}
\newcommand{\smallbasicstyle}{\small\fontfamily{\codefont}\selectfont}
\newcommand{\smallerbasicstyle}{\footnotesize\fontfamily{\codefont}\selectfont}

\newcommand{\numberstyle}[1]{\color{\numberColor}{\tiny #1}}
\newcommand{\commentstyle}[1]{\color{\commentColor}{#1}}
\newcommand{\stringstyle}[1]{\color{\stringColor}{#1}}
\newcommand{\contractstyle}[1]{\color{\contractColor}{#1}}
\newcommand{\assertstyle}[1]{\contractstyle{//\textbf{@assert}{#1}}} % does not work
\lstdefinelanguage[C0]{C}[ANSI]{C}{%
  numbers=none, numberstyle=\numberstyle,               % Line numbers
  stepnumber=1, numbersep=5pt,                          % Line numbers
  showspaces=false, showstringspaces=false,             % Spaces
  tabsize=4,                                            % Tabs
  breaklines=false, breakatwhitespace=false,            % Line breaks
  basicstyle=\basicstyle,                               % Code style
  commentstyle=\commentstyle,                           % Comment style
  stringstyle=\stringstyle,                             % String style
  columns=fixed,                                        % Column alignment
  mathescape=true, escapeinside={[*}{*]},               % escapes for $...$
  morekeywords={alloc, alloc_array, bool, string},      % C0 keywords
  morekeywords={assert, error},                         % C0 keywords
  %deletekeywords={union},                               % kw in C but not C0
  morekeywords=[2]{requires, ensures},                  % C0 @keywords
  morekeywords=[2]{loop_invariant, assert},             % C0 @keywords
  keywordstyle=[2]{\bfseries\contractstyle},
  moredelim=**[s][\contractstyle]{//@}{;},              % C0 assertions
  moredelim=**[s][\contractstyle]{/*@}{@*/},            % C0 assertions
  moredelim=**[s][\contractstyle]{//@assert\ }{;},      % C0 @assert
  moredelim=**[s][\contractstyle]{/*@assert\ }{@*/},    % C0 @assert
%  morekeywords=[3]{result, length, hastag},
%  keywordstyle=[3]{\itshape\contractstyle}
}


%%% listings style for coin
\newcommand{\shellstyle}{\bfseries\color{Black}}
\newcommand{\coinheaderstyle}{\color{Gray}}
\newcommand{\coininputstyle}{\color{Blue}}
\newcommand{\coinerrorstyle}{\color{Red}}
\lstdefinelanguage[coin]{C}[C0]{C}{%
  numbers=none,
  moredelim=[l][\shellstyle]{\%},
  moredelim=[l][\coinheaderstyle]{C0\ interpreter},
  moredelim=[l][\coinheaderstyle]{Type\ },
  moredelim=**[l][\coininputstyle]{-->},
  moredelim=**[l][\coininputstyle]{...},
  moredelim=[l][\coinerrorstyle]{error:},
  moredelim=[l][\coinerrorstyle]{Error:},
  moredelim=[l][\coinerrorstyle]{Abort\ trap:},
  moredelim=[l][\coinerrorstyle]{\ @},
}


%%% listings style for C0VM
\newcommand{\instructionColor}{Mahogany}

\newcommand{\poolstyle}[1]{\bfseries\commentstyle{#1}}
\newcommand{\functionstyle}[1]{\itshape\commentstyle{#1}}
\newcommand{\instructionstyle}[1]{\color{\instructionColor}{#1}}
\lstdefinelanguage{C0VM}{%
  numbers=left, numberstyle=\tiny, stepnumber=1, numbersep=5pt,   % Line numbers
  showspaces=false, showstringspaces=false,                       % Spaces
  tabsize=4,                                                      % Tabs
  breaklines=false, breakatwhitespace=false,                      % Line breaks
  basicstyle=\basicstyle,                                         % Code style
  morecomment=[l]{\#},
  commentstyle=\commentstyle,                                     % Comment style
  stringstyle=\stringstyle,                                       % String style
  columns=fixed,                                                  % Column alignment
  mathescape=true, escapeinside={[*}{*]},                         % escapes for $...$
  keywordstyle=[2]{\bfseries\contractstyle},
% Sections and related info
  moredelim=*[l][\poolstyle]{\#\ version},
  moredelim=*[l][\poolstyle]{\#\ int\ pool},
  moredelim=*[l][\poolstyle]{\#\ string\ pool},
  moredelim=*[l][\poolstyle]{\#\ function\ pool},
  moredelim=*[l][\poolstyle]{\#\ function\_pool},
  moredelim=*[l][\poolstyle]{\#\ function\ count},
  moredelim=*[l][\poolstyle]{\#\ number\ of},
  moredelim=*[l][\poolstyle]{\#\ code\ length},
  moredelim=*[l][\poolstyle]{\#\ native\ pool},
  moredelim=*[l][\poolstyle]{\#\ native\ count},
% Goto addresses
  moredelim=*[s][\functionstyle]{\#<}{>},
% C0VM instructions
  moredelim=*[l][\instructionstyle]{\#\ dup},           % Stack operations
  moredelim=*[l][\instructionstyle]{\#\ pop},
  moredelim=*[l][\instructionstyle]{\#\ swap},
  moredelim=*[l][\instructionstyle]{\#\ iadd},          % Arithmetic
  moredelim=*[l][\instructionstyle]{\#\ iand},
  moredelim=*[l][\instructionstyle]{\#\ idiv},
  moredelim=*[l][\instructionstyle]{\#\ imul},
  moredelim=*[l][\instructionstyle]{\#\ ior},
  moredelim=*[l][\instructionstyle]{\#\ irem},
  moredelim=*[l][\instructionstyle]{\#\ ishl},
  moredelim=*[l][\instructionstyle]{\#\ ishr},
  moredelim=*[l][\instructionstyle]{\#\ isub},
  moredelim=*[l][\instructionstyle]{\#\ ixor},
  moredelim=*[l][\instructionstyle]{\#\ vload},         % Local Variables
  moredelim=*[l][\instructionstyle]{\#\ vstore},
  moredelim=*[l][\instructionstyle]{\#\ aconst\_null},  % Constants
  moredelim=*[l][\instructionstyle]{\#\ bipush},
  moredelim=*[l][\instructionstyle]{\#\ ildc},
  moredelim=*[l][\instructionstyle]{\#\ aldc},
  moredelim=*[l][\instructionstyle]{\#\ nop},           % Control Flow
  moredelim=*[l][\instructionstyle]{\#\ if\_cmpeq},
  moredelim=*[l][\instructionstyle]{\#\ if\_cmpne},
  moredelim=*[l][\instructionstyle]{\#\ if\_icmplt},
  moredelim=*[l][\instructionstyle]{\#\ if\_icmpge},
  moredelim=*[l][\instructionstyle]{\#\ if\_icmpgt},
  moredelim=*[l][\instructionstyle]{\#\ if\_icmple},
  moredelim=*[l][\instructionstyle]{\#\ goto},
  moredelim=*[l][\instructionstyle]{\#\ athrow},
  moredelim=*[l][\instructionstyle]{\#\ assert},
  moredelim=*[l][\instructionstyle]{\#\ invokestatic},  % Functions
  moredelim=*[l][\instructionstyle]{\#\ return},
  moredelim=*[l][\instructionstyle]{\#\ invokenative},
  moredelim=*[l][\instructionstyle]{\#\ new},           % Memory
  moredelim=*[l][\instructionstyle]{\#\ newarray},
  moredelim=*[l][\instructionstyle]{\#\ arraylength},
  moredelim=*[l][\instructionstyle]{\#\ aaddf},
  moredelim=*[l][\instructionstyle]{\#\ aadds},
  moredelim=*[l][\instructionstyle]{\#\ imload},
  moredelim=*[l][\instructionstyle]{\#\ amload},
  moredelim=*[l][\instructionstyle]{\#\ imstore},
  moredelim=*[l][\instructionstyle]{\#\ amstore},
  moredelim=*[l][\instructionstyle]{\#\ cmload},
  moredelim=*[l][\instructionstyle]{\#\ cmstore},
}

\newcommand{\opcodestyle}[1]{\textbf{#1}}
\newcommand{\transitionstyle}[1]{\textcolor{blue}{#1}}
\newcommand{\operandstyle}[1]{\textcolor{Red}{#1}}
\newcommand{\arrowstyle}[1]{\bfseries\transitionstyle{#1}}
\newcommand{\effectstyle}[1]{\textcolor{MidnightBlue}{#1}}
\lstdefinelanguage{opsem}{%
  numbers=none, numberstyle=\tiny, stepnumber=1, numbersep=5pt,   % Line numbers
  showspaces=false, showstringspaces=false,                       % Spaces
  tabsize=4,                                                      % Tabs
  breaklines=false, breakatwhitespace=false,                      % Line breaks
  basicstyle=\smallbasicstyle,                                    % Code style
  xleftmargin=-3em,
  columns=fixed,                                                  % Column alignment
  mathescape=true, escapeinside={[*}{*]},                         % escapes for $...$
  keywordstyle=[2]{\bfseries\contractstyle},
% opcodes
  moredelim=*[l][\opcodestyle]{0x},
% C0VM instructions
  moredelim=*[l][\instructionstyle]{dup},           % Stack operations
  moredelim=*[l][\instructionstyle]{pop},
  moredelim=*[l][\instructionstyle]{swap},
  moredelim=*[l][\instructionstyle]{iadd},          % Arithmetic
  moredelim=*[l][\instructionstyle]{iand},
  moredelim=*[l][\instructionstyle]{idiv},
  moredelim=*[l][\instructionstyle]{imul},
  moredelim=*[l][\instructionstyle]{ior},
  moredelim=*[l][\instructionstyle]{irem},
  moredelim=*[l][\instructionstyle]{ishl},
  moredelim=*[l][\instructionstyle]{ishr},
  moredelim=*[l][\instructionstyle]{isub},
  moredelim=*[l][\instructionstyle]{ixor},
  moredelim=*[l][\instructionstyle]{vload},         % Local Variables
  moredelim=*[l][\instructionstyle]{vstore},
  moredelim=*[l][\instructionstyle]{aconst\_null},  % Constants
  moredelim=*[l][\instructionstyle]{bipush},
  moredelim=*[l][\instructionstyle]{ildc},
  moredelim=*[l][\instructionstyle]{aldc},
  moredelim=*[l][\instructionstyle]{nop},           % Control Flow
  moredelim=*[l][\instructionstyle]{if\_cmpeq},
  moredelim=*[l][\instructionstyle]{if\_cmpne},
  moredelim=*[l][\instructionstyle]{if\_icmplt},
  moredelim=*[l][\instructionstyle]{if\_icmpge},
  moredelim=*[l][\instructionstyle]{if\_icmpgt},
  moredelim=*[l][\instructionstyle]{if\_icmple},
  moredelim=*[l][\instructionstyle]{goto},
  moredelim=*[l][\instructionstyle]{athrow},
  moredelim=*[l][\instructionstyle]{assert},
  moredelim=*[l][\instructionstyle]{invokestatic},  % Functions
  moredelim=*[l][\instructionstyle]{return},
  moredelim=*[l][\instructionstyle]{invokenative},
  moredelim=*[l][\instructionstyle]{new},           % Memory
  moredelim=*[l][\instructionstyle]{newarray},
  moredelim=*[l][\instructionstyle]{arraylength},
  moredelim=*[l][\instructionstyle]{aaddf},
  moredelim=*[l][\instructionstyle]{aadds},
  moredelim=*[l][\instructionstyle]{imload},
  moredelim=*[l][\instructionstyle]{amload},
  moredelim=*[l][\instructionstyle]{imstore},
  moredelim=*[l][\instructionstyle]{amstore},
  moredelim=*[l][\instructionstyle]{cmload},
  moredelim=*[l][\instructionstyle]{cmstore},
% Stack transition
  moredelim=*[l][\transitionstyle]{S},
  moredelim=*[l][\transitionstyle]{.},
  moredelim=*[l][\arrowstyle]{->},
% Side effects
  moredelim=[l][\effectstyle]{(},
  moredelim=[s][\effectstyle]{each}{)},
  % morecomment=[n]{(}{)},
% Exception to side effects
  moredelim=[s][\transitionstyle]{(a+}{:*},
  moredelim=[s][\transitionstyle]{(a->}{:*},
% Goto addresses
  moredelim=*[s][\operandstyle]{<}{>},
  moredelim=*[l][\transitionstyle]{<<},
% Misc
  moredelim=*[l][\basicstyle]{S\ =},
  moredelim=*[l][\basicstyle]{V[0..num_vars)},
  moredelim=*[l][\basicstyle]{(unsigned)},
  moredelim=*[l][\basicstyle]{(signed)},
  moredelim=*[s][\basicstyle]{(\"}{\")},
  moredelim=*[l][\basicstyle]{(c1<<8|c2)\ (unsigned)},
  moredelim=*[l][\basicstyle]{(o1<<8|o2)\ (signed)},
  moredelim=*[l][\basicstyle]{(v:*\ or\ v:w32)},
}




%%% Common commands
\newcommand{\normallistings}{
  \lstset{language=[C0]C}
}
\newcommand{\smalllistings}{
  \lstset{%
    language=[C0]C,
    basicstyle=\smallbasicstyle,
  }
}
\newcommand{\smallerlistings}{
  \lstset{%
    language=[C0]C,
    basicstyle=\smallerbasicstyle,
  }
}

\normallistings

% Inline use of contract keywords
\newcommand{\requires}{{\contractstyle{\texttt{@requires}}}}
\newcommand{\ensures}{{\contractstyle{\texttt{@ensures}}}}
\newcommand{\loopinvariant}{{\contractstyle{\texttt{@loop\_invariant}}}}
\newcommand{\assert}{{\contractstyle{\texttt{@assert}}}}
\newcommand{\result}{{\contractstyle{\texttt{\texttt{\char`\\}\emph{result}}}}}
\newcommand{\length}[1]{{\contractstyle{\texttt{\texttt{\char`\\}\emph{length}#1}}}}
\newcommand{\old}[1]{{\contractstyle{\texttt{\texttt{\char`\\}\emph{old}#1}}}}
\newcommand{\hastag}[1]{{\contractstyle{\texttt{\texttt{\char`\\}\emph{hastag}#1}}}}
