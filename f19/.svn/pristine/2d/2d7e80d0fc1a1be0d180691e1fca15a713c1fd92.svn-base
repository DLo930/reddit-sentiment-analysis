#use <args>
#use <conio>
#use <file>
#use <string>

int main() {
  args_t args = args_parse();
  if (args->argc != 1) error("Wrong number of args");
  string arg = args->argv[0];

  if (string_equal(arg, "10x10-no-aliasing")) {
    pixel_t[] A = alloc_array(pixel_t, 100);
    for (int i = 0; i < 100; i++) A[i] = 0xFFFFFFFF;
    pixel_t[] B = quantize(A, 10, 10, 0);
    if (A == B) return 1;
  } else if (string_equal(arg, "1x1-manyvalues")) {
    pixel_t[] A = alloc_array(pixel_t, 1);
    int x = 0;
    for (int i = 0; i < 250000; i++) {
      for (int q = 0; q < 8; q++)
        //@loop_invariant q >= 0;
        {
          A[0] = x;
          int a = (A[0] >> 24) & 0xFF;
          int r = (A[0] >> 16) & ((0xFF >> q) << q);
          int g = (A[0] >> 8) & ((0xFF >> q) << q);
          int b = A[0] & ((0xFF >> q) << q);
          pixel_t[] B = quantize(A, 1, 1, q);
          //@assert \length(B) == 1;

          if (a != ((B[0] >> 24) & 0xFF)) return 1;
          if (r != ((B[0] >> 16) & 0xFF)) return 1;
          if (g != ((B[0] >> 8) & 0xFF)) return 1;
          if (b != (B[0] & 0xFF)) return 1;
        }
      x += 19937; // Cover the space of possible pixels somewhat well
    }

  } else if (string_equal(arg, "size-lies1")) {
    pixel_t[] A = alloc_array(pixel_t, 50);
    for (int i = 0; i < 50; i++) A[i] = 0xFFFFFFFF;
    quantize(A, 10, 10, 3);
  } else if (string_equal(arg, "size-lies2")) {
    pixel_t[] A = alloc_array(pixel_t, 50);
    for (int i = 0; i < 50; i++) A[i] = 0xFFFFFFFF;
    quantize(A, 5, 5, 3);
  } else if (string_equal(arg, "size-toosmall1")) {
    pixel_t[] A = alloc_array(pixel_t, 0);
    quantize(A, 0, 5, 3);
  } else if (string_equal(arg, "size-toosmall2")) {
    pixel_t[] A = alloc_array(pixel_t, 0);
    quantize(A, 5, 0, 3);
  } else if (string_equal(arg, "size-invalid")) {
    pixel_t[] A = alloc_array(pixel_t, 8287);
    for (int i = 0; i < 8287; i++) A[i] = 0xFFFFFFFF;
    quantize(A, 1147445003, 419965, 3);
  } else if (string_equal(arg, "size-quant-toobig")) {
    pixel_t[] A = alloc_array(pixel_t, 100);
    for (int i = 0; i < 100; i++) A[i] = 0xFFFFFFFF;
    quantize(A, 10, 10, 8);
  } else if (string_equal(arg, "size-quant-toosmall")) {
    pixel_t[] A = alloc_array(pixel_t, 100);
    for (int i = 0; i < 100; i++) A[i] = 0xFFFFFFFF;
    quantize(A, 10, 10, -1);

  } else {
    error("Bad argument");
  }

  return 0;

}
