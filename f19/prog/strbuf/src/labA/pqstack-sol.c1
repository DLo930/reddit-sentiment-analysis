#use <conio>

/*******************************************************/
/*** Partial stack implementation for you to finish ****/
/*******************************************************/

struct pq_elem {
  void *x;
  int priority;
};

bool higher_priority_elem(void* x, void* y) 
//@requires x != NULL && \hastag(struct pq_elem*, x);
//@requires y != NULL && \hastag(struct pq_elem*, y);
{
  int a = ((struct pq_elem*)x)->priority;
  int b = ((struct pq_elem*)y)->priority;
  return a > b; /*** XXX FINISH THIS LINE ***/
}

typedef struct stack_header stack;
struct stack_header {
  heap_t H;
  int pushcount;
};

bool is_stack(stack* S) {
  return S != NULL && S->H != NULL;
}

stack* stack_new() 
//@ensures is_stack(\result);
{
  stack* S = alloc(stack);
  S->H = heap_new(&higher_priority_elem);
  S->pushcount = 0;
  return S;
}

bool stack_empty(stack* S)
//@requires is_stack(S);
{
  return heap_empty(S->H);
}

void push(stack* S, void* x)
//@requires is_stack(S);
//@ensures is_stack(S);
{
  struct pq_elem* y = alloc(struct pq_elem);
  y->x = x;
  y->priority = S->pushcount;
  heap_add(S->H, (void*)y);
  (S->pushcount)++;
}

void* pop(stack* S) 
//@requires is_stack(S);
//@requires !stack_empty(S);
//@ensures is_stack(S);
{
  return ((struct pq_elem*)heap_rem(S->H))->x;
}

/************************/
/*** Code for testing ***/
/************************/

void* wrap(string s) {
  string* p = alloc(string);
  *p = s;
  return (void*)p;
}

int main() {
  stack* S = stack_new();
  push(S, wrap("you!"));
  push(S, wrap("Hello"));
  print("pop: "); println(*(string*)pop(S));
  push(S, wrap("see"));
  push(S, wrap("is"));
  push(S, wrap("it"));
  push(S, wrap("there"));
  print("pop: "); println(*(string*)pop(S));
  print("pop: "); println(*(string*)pop(S));
  print("pop: "); println(*(string*)pop(S));
  push(S, wrap("to"));
  push(S, wrap("good"));
  print("pop: "); println(*(string*)pop(S));
  print("pop: "); println(*(string*)pop(S));
  print("pop: "); println(*(string*)pop(S));
  print("pop: "); println(*(string*)pop(S));
  return 0;
}
