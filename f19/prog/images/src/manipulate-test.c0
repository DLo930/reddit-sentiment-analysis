#use <conio>
#use <string>
#use <args>
#use <parse>
#use <img>
#use <util>

int main() {
  args_t args = args_parse();
  if (args->argc != 1) error("Wrong number of args");
  string arg = args->argv[0];

  /* Load source image */
  image_t source = image_load(arg);
  if (source == NULL) error("Unable to load source image");
  int width = image_width(source);
  int height = image_height(source);
  pixel_t[] inpixels = image_data(source);

  /* Compute destination pixels */
  int outwidth = result_width(width, height);
  int outheight = result_height(width, height);
  pixel_t[] resultpixels = manipulate(inpixels, width, height);

  /* Make sure we're not getting bogus data back */
  //@assert outwidth > 0;
  //@assert outheight > 0;
  //@assert int_max() / outwidth >= outheight;
  //@assert \length(resultpixels) == outwidth * outheight;

  /* Form the destination image */
  image_t dest = image_create(outwidth, outheight);
  pixel_t[] outpixels = image_data(dest);
  for (int i = 0; i < outwidth*outheight; i++)
    //@loop_invariant 0 <= i;
    outpixels[i] = resultpixels[i];

  image_save(dest, "output.png");

  return 0;
}
